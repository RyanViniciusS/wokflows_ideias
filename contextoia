# ============================================
# PROJECT CONTEXT - WORKFLOW ENGINE (MVP)
# ============================================

## üß† Vis√£o Geral

Este projeto √© um Workflow Engine Conversacional inspirado no modelo do Typebot.

Ele permite:

- Criar workflows compostos por nodes conectados
- Executar fluxos passo a passo
- Persistir estado da execu√ß√£o
- Pausar execu√ß√£o aguardando input do usu√°rio
- Retomar execu√ß√£o posteriormente

A engine N√ÉO executa tudo de forma s√≠ncrona.
Ela executa at√© encontrar um ponto de espera (INPUT) e salva o estado.

Arquitetura orientada a execu√ß√£o stateful.


# ============================================
# üóÑÔ∏è ESTRUTURA DO BANCO
# ============================================

## TABLE: workflow

Representa um fluxo completo.

CREATE TABLE workflow (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    user_id VARCHAR(50) NOT NULL,
    account_id VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


## TABLE: node

Representa um bloco dentro do workflow.

Tipos poss√≠veis:
- START
- TEXT
- HTTP
- CONDITION
- INPUT
- ACTION

CREATE TABLE node (
    id VARCHAR(50) PRIMARY KEY,
    workflow_id VARCHAR(50) NOT NULL,
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50) NOT NULL,
    data JSON NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (workflow_id) REFERENCES workflow(id)
);


## TABLE: connection

Define a liga√ß√£o entre nodes.

CREATE TABLE connection (
    id VARCHAR(50) PRIMARY KEY,
    workflow_id VARCHAR(50) NOT NULL,
    from_node_id VARCHAR(50) NOT NULL,
    to_node_id VARCHAR(50) NOT NULL,
    from_output VARCHAR(50) DEFAULT 'main',
    to_input VARCHAR(50) DEFAULT 'main',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (workflow_id) REFERENCES workflow(id)
);


## TABLE: execution

Representa uma execu√ß√£o ativa ou finalizada de um workflow.

CREATE TABLE execution (
    id VARCHAR(50) PRIMARY KEY,
    workflow_id VARCHAR(50) NOT NULL,
    current_node_id VARCHAR(50),
    context JSON,
    status VARCHAR(20) DEFAULT 'running', -- running | waiting | finished
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (workflow_id) REFERENCES workflow(id)
);


# ============================================
# üöÄ ROTAS DA API
# ============================================

## 1Ô∏è‚É£ POST /node/test

Objetivo:
Executar um node isolado antes de salvar.

Regras:
- N√£o consulta workflow
- N√£o usa conex√µes
- N√£o cria execution
- Apenas executa a configura√ß√£o enviada

Fluxo:
Front envia config ‚Üí
Backend executa ‚Üí
Retorna preview


## 2Ô∏è‚É£ POST /workflow/:id/start

Objetivo:
Iniciar uma execu√ß√£o real.

Fluxo:

1. Buscar workflow
2. Buscar nodes
3. Buscar connections
4. Criar execution
5. Encontrar node START
6. Executar engine at√© encontrar:
   - INPUT
   - Ou finalizar fluxo
7. Atualizar execution
8. Retornar resposta ao cliente


## 3Ô∏è‚É£ POST /execution/:id/continue

Objetivo:
Continuar execu√ß√£o pausada.

Body esperado:
{
  "answer": "resposta do usu√°rio"
}

Fluxo:

1. Buscar execution
2. Recuperar context
3. Recuperar current_node
4. Salvar resposta no context
5. Continuar engine a partir do ponto salvo
6. Executar at√©:
   - Novo INPUT
   - Ou finaliza√ß√£o
7. Atualizar execution
8. Retornar pr√≥xima mensagem


# ============================================
# ‚öôÔ∏è ENGINE - L√ìGICA DE EXECU√á√ÉO
# ============================================

A engine executa incrementalmente.

Pseudo fluxo:

function runUntilWait(node, context):

    while node exists:

        switch(node.type):

            case "TEXT":
                process template
                salvar no context

            case "HTTP":
                executar requisi√ß√£o
                salvar response no context

            case "CONDITION":
                avaliar regra
                escolher conex√£o de sa√≠da

            case "INPUT":
                salvar execution
                retornar WAITING

        node = pr√≥ximo node conectado

    retornar FINISHED


A execu√ß√£o sempre termina em:

- WAITING (aguardando usu√°rio)
- FINISHED (fluxo conclu√≠do)


# ============================================
# üì¶ CONTEXTO GLOBAL
# ============================================

O context JSON armazena:

{
  "user": {},
  "responses": {},
  "external": {},
  "variables": {}
}

Ele √© compartilhado entre todos os nodes da execu√ß√£o.


# ============================================
# üéØ OBJETIVO DO MVP
# ============================================

Criar um motor de orquestra√ß√£o conversacional:

- Stateful
- Persistido
- Modular
- Extens√≠vel para SaaS
- Inspirado no modelo do Typebot
- Preparado para escalar com workers e filas


# ============================================
# üîÆ FUTURA EVOLU√á√ÉO
# ============================================

- WebSocket para execu√ß√£o em tempo real
- Redis para cache de execu√ß√£o
- Worker queue para execu√ß√£o ass√≠ncrona
- Execu√ß√£o paralela de branches
- Logs detalhados por execu√ß√£o
- Versionamento de workflow
- Engine baseada em eventos
